<% include ../partials/header %>

    <header class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1 class="display-4">Index | Tasks</h1>
        </div>
        <div class="container project-select">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Select Project
            </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <% projects.forEach(function(project){ %>
                    <a class="dropdown-item" href="/projects/<%= project._id %>"><%= project.name %></a>
                <% }); %>
             </div>
        </div>
    </header>
    
<div class="container">
    <ul class="list-group task-list ">
        <% tasks.forEach(function(task){ %>
            <div class="row" style="display:flex; flex-wrap: wrap;">
                <div class="col-12 table">
                    <li name="name" data-project-id="<%= task.project.id %>" data-id="<%= task._id %>" class="list-group-item clearfix">
                        <input type="checkbox" class="form-check-input checkbox">
                        <span class="task-item" contentEditable="true" data-id="<%= task.name %>"><%= task.name %></span>
                        <span class="delete-task float-right" ><a href="#"><i class="fas fa-times fa-lg"></i></a></span>
                            <div class="form-group select-box float-right">
                                <select class="form-control project-select">
                                    <% projects.forEach(function(project){ %>
                                        <option data-id="<%= project._id %>"><%= project.name %></option>
                                    <% }); %>
                                </select>
                                
                            </div>
                    </li>
                </div>
            </div>
        <% }); %>
    </ul>
            
            
</div>
<div id="sticky-btn">
    <a class="btn btn-primary btn-lg" href="#">Add Task</a>
</div>
             
<script>
// Edit item inline --> save when focus is lost
$(".list-group-item").focusout(function(){
var taskId = $(this).attr('data-id');
var list_item = $(this);
var taskname = list_item.find("span").text();
var projectname = list_item.find("select option:selected").text();
var projectid = list_item.find("select option:selected").attr('data-id');
console.log(projectname + "    " + projectid);
   $.ajax({
      method: "POST",
      url: "/tasks/" + taskId + "/?_method=PUT",
      data: {ID: taskId, name: taskname,  pName: projectname, pId: projectid},
      success: function(result) {
      }
    });
});
    
// display mathing Projekt to task in select box
$(function(){
    $("select > option").each(function(){
        var pID = $(this).closest("li").attr("data-project-id");
        if($(this).attr("data-id") == pID){
            $(this).attr("selected","selected");
        }
    });
});

// Delete item with checkbox

   $(".checkbox").on('change', function(){
         var taskId = $(this).parent().attr('data-id');
         $.ajax({
            method: "POST",
            url: "/tasks/" + taskId + "/?_method=DELETE",
            data: {id: taskId},
            success: function(result) {
                console.log("SUCCESS DELETE");
                location.reload(true);
            }
         });
   });
   
// delete task on button click
$(".delete-task").on('click', function(){
   var taskId = $(this).parent().attr('data-id');
   $.ajax({
      method: "POST",
      url: "/tasks/" + taskId + "/?_method=DELETE",
      data: {id: taskId},
      success: function(result) {
          console.log("SUCCESS DELETE");
          location.reload(true);
      }
   });
});

// Add new task in current list (without form)
$("#sticky-btn").click(function(){
   $.ajax({
      method: "POST",
      url: "/tasks",
      data: {name: "New Task"},
      success: function(result) {
        console.log("SUCCESS ADD");
        location.reload(true);
      }
    });
});
</script> 
            
<% include ../partials/footer %>